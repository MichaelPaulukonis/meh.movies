# Product Requirements Document (PRD): OpenRouter Integration & Model Agnosticism

**Date:** 2026-02-07
**Status:** Finalized
**Project:** meh.movies
**Lead:** Michael Paulukonis

---

## 1. Analysis & Feedback (Context)

### Documentation Review

The migration from `@anthropic/ai-sdk` to OpenRouter is technically straightforward but requires careful handling of schema enforcement and environment consistency.

* **Well-Defined:** Technical steps for SDK replacement and tool mapping.
* **Validated Assumptions:** We are prioritizing Anthropic models via OpenRouter first to ensure parity before exploring cheaper alternatives.
* **Key Focus:** Unification of the standalone enrichment script (`src/enrich-db.ts`) and the Nuxt web app.

---

## 2. Problem Definition

### Problem Statement

The current "meh.movies" infrastructure is tightly coupled to the Anthropic AI SDK. This creates vendor lock-in and prevents the use of cost-effective models for high-volume tasks like movie enrichment.

### User Pain Points

* **High Operational Costs:** Claude 3.5 Sonnet is overkill for repetitive metadata enrichment.
* **Vendor Lock-in:** API availability or pricing changes at Anthropic directly threaten the service.
* **Configuration Drift:** The enrichment script and the web app use different patterns for LLM calls.

### Opportunity

By integrating OpenRouter, we can reduce enrichment costs by an estimated **60-80%** using models like `google/gemini-2.0-flash-lite` while maintaining premium performance for user-facing recommendations.

---

## 3. Success Criteria

* **Zero Feature Regression:** Recommendation and Enrichment features must maintain 100% functional parity.
* **Unified Configuration:** A single source of truth for LLM configuration that works for both `tsx` scripts and Nuxt server routes.
* **Verification:** Successful enrichment of a 10-movie "Golden Dataset" (`[14283, 3105, 27891, 44102, 1956, 38922, 1204, 25530, 8431, 1672]`).
* **Observability:** Ability to swap models via `.env` without touching code.

---

## 4. Structured Requirements

### 4.1 Functional Requirements

* **Multi-Model Support:** Transition all LLM calls to a unified OpenRouter client.
* **Schema Enforcement:** Use OpenAI-style `tools` or `response_format` to maintain strict JSON schema adherence for enrichment.
* **Unified Configuration:** Support `OPENROUTER_API_KEY` and model-specific environment variables (`LLM_MODEL_ENRICHMENT`, `LLM_MODEL_RECOMMENDATION`).
* **Message Adapter:** Ensure Anthropic-style `system` prompts are correctly mapped to OpenAI `role: "system"` messages.

### 4.2 Non-Functional Requirements

* **Environment Agnosticism:** The LLM provider must work in both Nuxt (browser/server) and standalone Node.js environments.
* **Maintainability:** Use an "Adapter Pattern" to abstract the LLM client, making future transitions (e.g., direct Gemini SDK) trivial.

---

## 5. User-Centered Design

### 5.1 Use Cases

* **System Maintenance:** "I want to switch enrichment models via an environment variable to save costs without breaking the database schema."
* **End User Experience:** "I want vibe-matched recommendations that feel snappily delivered, regardless of the underlying model."

### 5.2 Edge Cases

* **Invalid JSON:** Skip records that fail schema validation during enrichment to prevent database corruption.
* **API Downtime:** Graceful handling of OpenRouter 429/500 errors.

---

## 6. Technical Considerations

### 6.1 Architecture: The "LLM Provider"

* **`server/utils/llm-provider.ts`**: A shared utility that detects the environment and returns a configured OpenAI client pointed at the OpenRouter base URL.
* **Nuxt Runtime Config**: Integrated into `nuxt.config.ts` for secure API key management in the web app.

---

## 7. Implementation Plan

### Phase 1: Foundation (Completed)

* Install `openai` SDK.
* Create `llm-provider.ts` abstraction.
* Update `nuxt.config.ts`.

### Phase 2: Enrichment Migration (Completed)

* Refactor `src/enrich-db.ts` to use OpenRouter.
* Convert tool-calling syntax to OpenAI format.

### Phase 3: Recommendation Migration (Completed)

* Refactor `server/utils/llm.ts` to use OpenRouter.
* Verify vibe-matching logic with Claude-3.5-Sonnet via OpenRouter.

### Phase 4: Future Explorations

* Benchmark non-Anthropic models against the "Golden Dataset".
* Introduce token/cost logging for better observability.
